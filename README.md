# Spacebar Helm Chart

> **Note:** This repository and Helm chart were generated by Cursor AI from a plan. See the plan for design decisions and scope.

Kubernetes Helm chart for [Spacebar](https://spacebar.chat) (Discord-compatible chat, voice and video platform). Supports k3s and EKS, with optional [CloudNative-PG](https://cloudnative-pg.io/) PostgreSQL, default Traefik Ingress, and S3 CDN storage.

## Chart location

- **GitHub:** `https://github.com/<owner>/spacebarchart` (replace `<owner>` with your org or username)
- Chart path in repo: `charts/spacebar`
- **Helm repo (after enabling GitHub Pages):** `https://<owner>.github.io/spacebarchart`

## Install from GitHub (Helm repo)

After the chart is published (push to `main` runs the [release workflow](.github/workflows/release-charts.yml) and updates the `gh-pages` branch):

1. **Enable GitHub Pages** in the repo: **Settings → Pages → Source:** `gh-pages` branch (root). The workflow creates/updates `gh-pages` automatically.
2. Add the Helm repo and install:

```bash
helm repo add spacebar https://<owner>.github.io/spacebarchart
helm repo update
helm install spacebar spacebar/spacebar -n spacebar --create-namespace \
  --set ingress.host=spacebar.example.com \
  --set storage.bucket=my-bucket \
  --set storage.region=us-east-1
```

Replace `<owner>` with your GitHub org or username.

## Quick start (from source)

```bash
# Clone the chart repo (or use your fork)
git clone https://github.com/<owner>/spacebarchart
cd spacebarchart

# Fetch dependencies (cert-manager is included by default; optional CNPG)
helm dependency update ./charts/spacebar

# Optional: install CloudNative-PG operator separately (or set postgresql.installOperator=true)
# helm repo add cnpg https://cloudnative-pg.github.io/charts
# helm install cnpg cnpg/cloudnative-pg -n cnpg-system --create-namespace

# Install Spacebar from the chart in this repo (includes cert-manager)
helm install spacebar ./charts/spacebar -n spacebar --create-namespace \
  --set ingress.host=spacebar.example.com \
  --set storage.bucket=my-bucket \
  --set storage.region=us-east-1
```

Provide S3 credentials via a Kubernetes secret (or IRSA on EKS) and set `existingSecret` if needed.

**Let's Encrypt (Traefik):** cert-manager is installed by default. Set `ingress.letsEncrypt.enabled=true`, `ingress.letsEncrypt.email`, and optionally `ingress.letsEncrypt.createClusterIssuer=true` to get TLS certs automatically. Set `certManager.install: false` if you already have cert-manager. See [charts/spacebar/README.md](charts/spacebar/README.md) for full configuration.

## Terraform (EKS)

See [examples/eks](examples/eks) for a minimal EKS + Spacebar Terraform example using `helm_release`.

## Publishing the chart repo (maintainers)

This section describes the GitHub actions and settings maintainers need so users can run `helm repo add spacebar https://<owner>.github.io/spacebarchart` and install the chart from GitHub.

### One-time setup

1. **Create the `gh-pages` branch (if it does not exist)**  
   The [chart-releaser-action](https://github.com/helm/chart-releaser-action) can create it on the first run; if you prefer to create it yourself:
   ```bash
   git checkout --orphan gh-pages
   git reset --hard
   echo "# Helm chart repo" > README.md
   git add README.md
   git commit -m "Initialize gh-pages for Helm chart repo"
   git push -u origin gh-pages
   git checkout main
   ```

2. **Enable GitHub Pages**  
   - In the repo: **Settings → Pages**.  
   - Under **Build and deployment**, set **Source** to **Deploy from a branch**.  
   - Set **Branch** to `gh-pages` and **Folder** to `/ (root)`.  
   - Save. The Helm repo URL will be `https://<owner>.github.io/spacebarchart` (replace `<owner>` with the repo owner).

3. **Workflow permissions**  
   The workflow needs write access to contents (releases and `gh-pages`).  
   - **Settings → Actions → General**.  
   - Under **Workflow permissions**, choose **Read and write permissions** for the default `GITHUB_TOKEN`, then save.  
   - If the repo uses strict defaults, the workflow file already requests `contents: write`; ensure the org does not override it.

4. **Trigger the first publish**  
   Push a commit to `main` or run the workflow manually (**Actions → Release Charts → Run workflow**).  
   - The workflow packages `charts/spacebar`, creates a **GitHub Release** (e.g. `spacebar-0.1.0`) with the `.tgz` attached, and updates `gh-pages` with `index.yaml`.  
   - After a minute or two, `https://<owner>.github.io/spacebarchart/index.yaml` should be reachable.

### Publishing a new chart version

1. **Bump the chart version**  
   Edit `charts/spacebar/Chart.yaml` and increase `version` (e.g. `0.1.0` → `0.1.1`). Optionally set `appVersion` to match the Spacebar server version.

2. **Commit and push to `main`**  
   ```bash
   git add charts/spacebar/Chart.yaml
   git commit -m "chore(helm): release spacebar chart 0.1.1"
   git push origin main
   ```

3. **Let the workflow run**  
   On push to `main`, the **Release Charts** workflow runs. It only creates a new release if the chart version is **new** (not already present in GitHub Releases). So bumping the version and pushing is enough to publish.

4. **Optional: run the workflow manually**  
   **Actions → Release Charts → Run workflow → Run workflow.** Use this to re-run without a new commit (e.g. after fixing a failed run or regenerating `index.yaml`).

### What the workflow does

- **Trigger:** Push to `main` or manual dispatch.  
- **Steps:** Checkout repo (full history), configure Git, then run [helm/chart-releaser-action](https://github.com/helm/chart-releaser-action) with `charts_dir: charts`.  
- **For each chart** in `charts/` (e.g. `spacebar`):  
  - Compares the chart’s `version` in `Chart.yaml` to existing **GitHub Release** tags (e.g. `spacebar-0.1.0`).  
  - If the version is new: runs `helm package`, creates a GitHub Release with that tag, uploads the `.tgz`, and updates the `gh-pages` branch with an `index.yaml` that points at the release assets.  
  - If the version already has a release: does nothing for that chart.  
- **Result:** Users can run `helm repo add spacebar https://<owner>.github.io/spacebarchart` and `helm install spacebar spacebar/spacebar ...`.

### Troubleshooting

| Issue | What to do |
|-------|------------|
| `https://<owner>.github.io/spacebarchart/index.yaml` returns 404 | Confirm **Settings → Pages** uses branch `gh-pages` and root. Wait a few minutes after the first workflow run. Check **Actions** for a successful run and that `gh-pages` was updated. |
| Workflow fails with "resource not accessible by integration" or 403 | Ensure **Settings → Actions → General** gives the default `GITHUB_TOKEN` **Read and write** workflow permissions. |
| New version does not appear after push | The workflow only releases **new** versions. Ensure `version` in `charts/spacebar/Chart.yaml` was increased and pushed. Check **Releases** for an existing tag (e.g. `spacebar-0.1.0`) and **Actions** for the latest run log. |
| Want to re-publish the same chart version | Not recommended. Bump the version and push instead. To force re-packaging without a new release, you would need to delete the existing GitHub Release/tag and re-run the workflow (use with care). |

**Helm repo URL for users:** `https://<owner>.github.io/spacebarchart` (replace `<owner>` with the repo owner).

## Links

- [Spacebar](https://spacebar.chat) / [GitHub](https://github.com/spacebarchat)
- [Spacebar docs](https://docs.spacebar.chat/setup/server/)
- [CloudNative-PG](https://cloudnative-pg.io/)
