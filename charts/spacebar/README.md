# Spacebar Helm Chart

> **Note:** This chart was generated by Cursor AI from a plan.

Helm chart for [Spacebar](https://spacebar.chat) - a Discord-compatible chat, voice and video platform. Deploys Spacebar server with optional [CloudNative-PG](https://cloudnative-pg.io/) PostgreSQL, default Traefik Ingress, and S3 CDN storage.

## Chart location

- **GitHub:** `https://github.com/<owner>/spacebarchart` (replace `<owner>` with your org or username)
- Chart path: `charts/spacebar`
- **Helm repo (use this for install):** `https://khaleb7.github.io/spacebarchart` (or `https://<owner>.github.io/spacebarchart` for your fork)

## Requirements

- Kubernetes 1.24+
- Helm 3.x
- Traefik Ingress Controller (default) or NGINX/ALB
- **cert-manager** is installed by default by this chart. **If cert-manager is already in the cluster, set `certManager.install: false`** or install will fail with CRD ownership errors.
- For PostgreSQL: [CloudNative-PG operator](https://cloudnative-pg.io/documentation/current/installation_upgrade/) installed (optionally via this chart with `postgresql.installOperator: true`)

## Installation

### Install from Helm repo (recommended)

Add this chart repo and install:

```bash
helm repo add spacebar https://khaleb7.github.io/spacebarchart
helm repo update
helm install spacebar spacebar/spacebar -n spacebar --create-namespace \
  --set ingress.host=spacebar.example.com \
  --set storage.bucket=my-bucket \
  --set storage.region=us-east-1
```

For your own fork, use `https://<owner>.github.io/spacebarchart` instead. The chart is published automatically on push to `main` via [release-charts.yml](../../.github/workflows/release-charts.yml).

**If cert-manager is already installed**, add `--set certManager.install=false`:

```bash
helm install spacebar spacebar/spacebar -n spacebar --create-namespace \
  --set certManager.install=false \
  --set ingress.host=spacebar.example.com \
  --set storage.bucket=my-bucket \
  --set storage.region=us-east-1
```

### Quick start (from source)

1. Install CloudNative-PG operator (if using in-cluster Postgres):

   ```bash
   helm repo add cnpg https://cloudnative-pg.github.io/charts
   helm install cnpg cnpg/cloudnative-pg -n cnpg-system --create-namespace
   ```

2. Clone the chart repo and install Spacebar:

   ```bash
   git clone https://github.com/<owner>/spacebarchart
   cd spacebarchart
   helm install spacebar ./charts/spacebar -n spacebar --create-namespace \
     --set ingress.host=spacebar.local \
     --set storage.bucket=my-spacebar-cdn \
     --set storage.region=us-east-1
   ```

   For S3 you must provide credentials via an existing secret (keys: `STORAGE_BUCKET`, `STORAGE_REGION`, and `AWS_ACCESS_KEY_ID`/`AWS_SECRET_ACCESS_KEY`, or use IRSA on EKS) and set `existingSecret` or create the secret manually and reference it.

### With in-chart CNPG operator (k3s)

From the repo root (after `git clone https://github.com/<owner>/spacebarchart`):

```bash
helm dependency update ./charts/spacebar
helm install spacebar ./charts/spacebar -n spacebar --create-namespace \
  --set postgresql.installOperator=true \
  --set ingress.host=spacebar.local \
  --set storage.bucket=my-bucket \
  --set storage.region=us-east-1
```

### Let's Encrypt (Traefik + cert-manager)

**cert-manager is installed by default** with this chart. Enable Let's Encrypt and set your ACME account email:

```bash
helm repo add spacebar https://khaleb7.github.io/spacebarchart
helm repo update
helm install spacebar spacebar/spacebar -n spacebar --create-namespace \
  --set ingress.host=spacebar.example.com \
  --set ingress.letsEncrypt.enabled=true \
  --set ingress.letsEncrypt.email=admin@example.com \
  --set ingress.letsEncrypt.createClusterIssuer=true \
  --set storage.bucket=my-bucket \
  --set storage.region=us-east-1
```

Set **certManager.install: false** if cert-manager is already installed in the cluster.

- **createClusterIssuer: true** — chart creates a ClusterIssuer (HTTP-01) for this release; no existing cert-manager issuer needed.
- **clusterIssuer: "letsencrypt-prod"** — use an existing ClusterIssuer; set this and leave **createClusterIssuer: false**.

### EKS (Terraform)

See [examples/eks](../../examples/eks) for a minimal EKS + Terraform example that installs this chart via `helm_release`.

## Configuration

| Key | Default | Description |
|-----|---------|-------------|
| `image.repository` | `ccgurley/spacebar-server` | Spacebar server image (official `spacebarchat/server` may be unavailable; override or build from [source](https://github.com/spacebarchat/server)) |
| `image.tag` | `latest` | Image tag |
| `replicaCount` | `1` | Number of replicas (scale >1 requires RabbitMQ) |
| `database.enabled` | `true` | Use PostgreSQL (CloudNative-PG Cluster or external) |
| `database.externalUrl` | — | External Postgres URL (in secret); use when not using CNPG Cluster |
| `postgresql.installOperator` | `false` | Install CloudNative-PG operator as subchart |
| `postgresql.cluster.instances` | `1` | CNPG Cluster instance count |
| `postgresql.cluster.storage.size` | `1Gi` | CNPG storage size |
| `storage.provider` | `s3` | CDN storage: `s3` or `file` |
| `storage.bucket` | `""` | S3 bucket name (required for S3) |
| `storage.region` | `""` | S3 region (required for S3) |
| `ingress.enabled` | `true` | Create Ingress |
| `ingress.className` | `traefik` | Ingress class (Traefik, nginx, alb) |
| `ingress.host` | `spacebar.local` | Ingress host |
| `ingress.tls` | `[]` | TLS config (secretName, hosts); optional when using Let's Encrypt |
| `ingress.letsEncrypt.enabled` | `false` | Request TLS cert from Let's Encrypt via cert-manager |
| `ingress.letsEncrypt.email` | `""` | ACME account email (required when Let's Encrypt enabled) |
| `ingress.letsEncrypt.clusterIssuer` | `""` | Existing ClusterIssuer name (e.g. letsencrypt-prod); empty when using createClusterIssuer |
| `ingress.letsEncrypt.createClusterIssuer` | `false` | Create a ClusterIssuer (HTTP-01) for this release |
| `certManager.install` | `true` | Install cert-manager as a chart dependency (set false if already installed) |
| `existingSecret` | `""` | Existing secret for DATABASE, S3, JWT, etc. |

Public endpoints (`api_endpointPublic`, `cdn_endpointPublic`, `gateway_endpointPublic`) are derived from `ingress.host` and `ingress.tls` and written into the config file at `CONFIG_PATH` for client discovery.

## Storage (S3)

The chart uses S3 as the default CDN storage backend. Spacebar stores **user uploads** in this bucket: avatars, attachments, emoji, guild icons, and other CDN-served assets. The API and Gateway read/write these objects via the Spacebar server process.

### Required configuration

- **`storage.bucket`** — S3 bucket name. Create the bucket in the same region as your cluster (or a region you accept for latency/cost).
- **`storage.region`** — AWS region of the bucket (e.g. `us-east-1`). Must match the bucket’s region.

### Credentials

- **EKS (recommended):** Use [IRSA](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html) (IAM Role for Service Account). Attach an IAM policy to the Spacebar pod’s service account that allows `s3:GetObject`, `s3:PutObject`, `s3:DeleteObject`, and `s3:ListBucket` on the bucket (and optionally the bucket prefix). No `AWS_ACCESS_KEY_ID` or `AWS_SECRET_ACCESS_KEY` in a secret is needed; the chart can still set `STORAGE_BUCKET` and `STORAGE_REGION` via ConfigMap or values.
- **Static credentials:** Create a Kubernetes secret with keys `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` (and optionally `STORAGE_BUCKET`, `STORAGE_REGION`). Set `existingSecret` to that secret’s name. The IAM user or role must have the same S3 permissions as above.

### Implications

| Topic | Implication |
|-------|-------------|
| **Bucket ownership** | The chart does not create the bucket. Create it (e.g. Terraform, AWS Console) and ensure the Spacebar workload has IAM permission to read/write. |
| **Multi-replica** | If you scale Spacebar replicas beyond 1, all pods must use the same bucket (and region). S3 is shared; no extra config needed. |
| **Cost** | Storage and request costs apply. Consider S3 lifecycle rules (e.g. move old objects to Glacier) or size limits if you need to cap cost. |
| **Encryption** | Enable S3 server-side encryption (SSE-S3 or SSE-KMS) on the bucket if you need encryption at rest. The chart does not configure this. |
| **CORS** | If clients upload directly to S3 (Spacebar may serve uploads via the API instead), configure CORS on the bucket. For typical Spacebar usage (upload through the API), CORS may not be required. |
| **Existing data** | Switching from file storage to S3 (or vice versa) requires migrating existing CDN assets; the chart does not migrate. |

### Optional: file storage

For local dev or single-node clusters, you can override to file storage: set `storage.provider: file` and optionally `storage.existingClaim` (or let the chart create a PVC). All CDN data then lives on the volume; not suitable for multi-replica or durable production use.

## Troubleshooting

| Error | Fix |
|-------|-----|
| `CustomResourceDefinition ... exists and cannot be imported ... invalid ownership metadata; label validation error: missing key "app.kubernetes.io/managed-by"` | cert-manager is already installed in the cluster. Install with **`--set certManager.install=false`** so the chart does not try to manage cert-manager CRDs. |
| `ErrImagePull` / `ImagePullBackOff` for `spacebarchat/server:latest: not found` | The default image is now `ccgurley/spacebar-server:latest`. If you overrode to `spacebarchat/server` and it fails, use **`--set image.repository=ccgurley/spacebar-server`** or build from [source](https://github.com/spacebarchat/server) and set `image.repository` to your image. |

## Uninstall

```bash
helm uninstall spacebar -n spacebar
```

If you used `postgresql.installOperator: true`, the CNPG operator is in `cnpg-system`; remove it separately if desired.

## Links

- [Spacebar](https://spacebar.chat) / [GitHub](https://github.com/spacebarchat)
- [Spacebar server setup](https://docs.spacebar.chat/setup/server/)
- [CloudNative-PG](https://cloudnative-pg.io/)
