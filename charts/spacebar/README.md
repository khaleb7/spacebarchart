# Spacebar Helm Chart

> **Note:** This chart was generated by Cursor AI from a plan.

Helm chart for [Spacebar](https://spacebar.chat) - a Discord-compatible chat, voice and video platform. Deploys Spacebar server with optional [CloudNative-PG](https://cloudnative-pg.io/) PostgreSQL, default Traefik Ingress, and S3 CDN storage.

## Chart location

- **GitHub:** `https://github.com/<owner>/spacebarchart` (replace `<owner>` with your org or username)
- Chart path: `charts/spacebar`

## Requirements

- Kubernetes 1.24+
- Helm 3.x
- Traefik Ingress Controller (default) or NGINX/ALB
- For PostgreSQL: [CloudNative-PG operator](https://cloudnative-pg.io/documentation/current/installation_upgrade/) installed (optionally via this chart with `postgresql.installOperator: true`)

## Installation

### Quick start (k3s / local)

1. Install CloudNative-PG operator (if using in-cluster Postgres):

   ```bash
   helm repo add cnpg https://cloudnative-pg.github.io/charts
   helm install cnpg cnpg/cloudnative-pg -n cnpg-system --create-namespace
   ```

2. Clone the chart repo and install Spacebar:

   ```bash
   git clone https://github.com/<owner>/spacebarchart
   cd spacebarchart
   helm install spacebar ./charts/spacebar -n spacebar --create-namespace \
     --set ingress.host=spacebar.local \
     --set storage.bucket=my-spacebar-cdn \
     --set storage.region=us-east-1
   ```

   For S3 you must provide credentials via an existing secret (keys: `STORAGE_BUCKET`, `STORAGE_REGION`, and `AWS_ACCESS_KEY_ID`/`AWS_SECRET_ACCESS_KEY`, or use IRSA on EKS) and set `existingSecret` or create the secret manually and reference it.

### With in-chart CNPG operator (k3s)

From the repo root (after `git clone https://github.com/<owner>/spacebarchart`):

```bash
helm dependency update ./charts/spacebar
helm install spacebar ./charts/spacebar -n spacebar --create-namespace \
  --set postgresql.installOperator=true \
  --set ingress.host=spacebar.local \
  --set storage.bucket=my-bucket \
  --set storage.region=us-east-1
```

### Let's Encrypt (Traefik + cert-manager)

Requires [cert-manager](https://cert-manager.io/) installed in the cluster. Enable Let's Encrypt and set your ACME account email:

```bash
# Install cert-manager (if not already)
helm repo add jetstack https://charts.jetstack.io
helm install cert-manager jetstack/cert-manager -n cert-manager --create-namespace --set crds.enabled=true

# Install Spacebar with Let's Encrypt (creates Certificate + optional ClusterIssuer)
helm install spacebar ./charts/spacebar -n spacebar --create-namespace \
  --set ingress.host=spacebar.example.com \
  --set ingress.letsEncrypt.enabled=true \
  --set ingress.letsEncrypt.email=admin@example.com \
  --set ingress.letsEncrypt.createClusterIssuer=true \
  --set storage.bucket=my-bucket \
  --set storage.region=us-east-1
```

- **createClusterIssuer: true** — chart creates a ClusterIssuer (HTTP-01) for this release; no existing cert-manager issuer needed.
- **clusterIssuer: "letsencrypt-prod"** — use an existing ClusterIssuer; set this and leave **createClusterIssuer: false**.

### EKS (Terraform)

See [examples/eks](../../examples/eks) for a minimal EKS + Terraform example that installs this chart via `helm_release`.

## Configuration

| Key | Default | Description |
|-----|---------|-------------|
| `image.repository` | `spacebarchat/server` | Spacebar server image |
| `image.tag` | `latest` | Image tag |
| `replicaCount` | `1` | Number of replicas (scale >1 requires RabbitMQ) |
| `database.enabled` | `true` | Use PostgreSQL (CloudNative-PG Cluster or external) |
| `database.externalUrl` | — | External Postgres URL (in secret); use when not using CNPG Cluster |
| `postgresql.installOperator` | `false` | Install CloudNative-PG operator as subchart |
| `postgresql.cluster.instances` | `1` | CNPG Cluster instance count |
| `postgresql.cluster.storage.size` | `1Gi` | CNPG storage size |
| `storage.provider` | `s3` | CDN storage: `s3` or `file` |
| `storage.bucket` | `""` | S3 bucket name (required for S3) |
| `storage.region` | `""` | S3 region (required for S3) |
| `ingress.enabled` | `true` | Create Ingress |
| `ingress.className` | `traefik` | Ingress class (Traefik, nginx, alb) |
| `ingress.host` | `spacebar.local` | Ingress host |
| `ingress.tls` | `[]` | TLS config (secretName, hosts); optional when using Let's Encrypt |
| `ingress.letsEncrypt.enabled` | `false` | Request TLS cert from Let's Encrypt via cert-manager |
| `ingress.letsEncrypt.email` | `""` | ACME account email (required when Let's Encrypt enabled) |
| `ingress.letsEncrypt.clusterIssuer` | `""` | Existing ClusterIssuer name (e.g. letsencrypt-prod); empty when using createClusterIssuer |
| `ingress.letsEncrypt.createClusterIssuer` | `false` | Create a ClusterIssuer (HTTP-01) for this release; requires cert-manager |
| `existingSecret` | `""` | Existing secret for DATABASE, S3, JWT, etc. |

Public endpoints (`api_endpointPublic`, `cdn_endpointPublic`, `gateway_endpointPublic`) are derived from `ingress.host` and `ingress.tls` and written into the config file at `CONFIG_PATH` for client discovery.

## Storage (S3)

Default CDN storage is S3. Provide:

- `storage.bucket` and `storage.region`
- Credentials via:
  - **EKS**: IRSA (IAM Role for Service Account); no keys in secret
  - **Else**: Secret with keys `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, and optionally `STORAGE_BUCKET`, `STORAGE_REGION`

Set `existingSecret` to the name of the secret containing these keys.

## Uninstall

```bash
helm uninstall spacebar -n spacebar
```

If you used `postgresql.installOperator: true`, the CNPG operator is in `cnpg-system`; remove it separately if desired.

## Links

- [Spacebar](https://spacebar.chat) / [GitHub](https://github.com/spacebarchat)
- [Spacebar server setup](https://docs.spacebar.chat/setup/server/)
- [CloudNative-PG](https://cloudnative-pg.io/)
